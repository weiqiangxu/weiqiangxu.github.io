"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4365],{6262:(i,s)=>{s.A=(i,s)=>{const a=i.__vccOpts||i;for(const[i,n]of s)a[i]=n;return a}},9047:(i,s,a)=>{a.r(s),a.d(s,{comp:()=>e,data:()=>h});var n=a(641);const l={},e=(0,a(6262).A)(l,[["render",function(i,s){return(0,n.uX)(),(0,n.CE)("div",null,s[0]||(s[0]=[(0,n.Fv)('<blockquote><p>kubernetes网络解决方案flannel如何使用，拓扑图理解</p></blockquote><h3 id="_1-kubernetes如何接入flannale" tabindex="-1"><a class="header-anchor" href="#_1-kubernetes如何接入flannale"><span>1.kubernetes如何接入flannale</span></a></h3><p><a href="https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" target="_blank" rel="noopener noreferrer">k8s/概念/扩展/网络插件</a><a href="https://github.com/containerd/containerd/blob/main/script/setup/install-cni" target="_blank" rel="noopener noreferrer">k8s/概念/扩展/网络插件/containerd安装网络插件</a><a href="https://github.com/cri-o/cri-o/blob/main/contrib/cni/README.md" target="_blank" rel="noopener noreferrer">k8s/概念/扩展/网络插件/CRI-O安装网络插件</a><a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/#networking-and-network-policy" target="_blank" rel="noopener noreferrer">k8s/概念/集群管理/安装扩展</a><a href="https://github.com/flannel-io/flannel#deploying-flannel-with-kubectl" target="_blank" rel="noopener noreferrer">deploying-flannel-with-kubectl</a><a href="https://github.com/flannel-io/flannel#deploying-flannel-with-helm" target="_blank" rel="noopener noreferrer">deploying-flannel-with-helm</a></p><blockquote><p>安装 cni-plugins 网络插件，然后安装 flannel</p></blockquote><h3 id="_2-flannel通信原理简述" tabindex="-1"><a class="header-anchor" href="#_2-flannel通信原理简述"><span>2.flannel通信原理简述</span></a></h3><ol><li>同一个Pod内的所有容器就会共享同一个网络命名空间，在同一个Pod之间的容器可以直接使用localhost进行通信；</li><li>每宿主机上运行名为flanneld，负责为宿主机预先分配一个子网，并为Pod分配IP地址；</li><li>拓扑图来看，同一个宿主机上的pod的网卡查到pair对，pair对端插docker0网桥(或者cni0)</li><li>当访问本机的cni0网段的pod的ip的时候，路由表会直接指向本机直接网关cni0</li><li>当访问其他宿主机上pod的时候，路由表会将数据指向flannel.1网卡，此时flannale.1网卡会将数据指向flanneld进程</li><li>Flannel会根据自己的路由表，将数据包封装成特定的协议（如VXLAN或UDP），并通过UDP或者其他方式将数据包发送到目标节点的Flannel网卡；</li><li>flannel.1网卡接收到数据以后不是通过iptable之类转发数据而是flanneld进程自己通过隧道或者自身的路由转发数据</li><li>同一个pod内的所有容器共享网络命名空间</li></ol><figure><img src="/images/flannel-docker.webp" alt="flannel-docker拓扑图" tabindex="0" loading="lazy"><figcaption>flannel-docker拓扑图</figcaption></figure><h3 id="_3-flannel下网卡网桥查看" tabindex="-1"><a class="header-anchor" href="#_3-flannel下网卡网桥查看"><span>3.flannel下网卡网桥查看</span></a></h3><h6 id="_1-网卡列表和网段分配" tabindex="-1"><a class="header-anchor" href="#_1-网卡列表和网段分配"><span>1.网卡列表和网段分配</span></a></h6><ul><li>Cni0网桥</li><li>每创建一个pod都会创建一对 veth pair，一端是pod中的eth0，另一端在Cni0网桥中的端口 （网卡）</li><li>Flannel.1（overlay网络设备，vxlan报文的处理（封包和解包），node之间pod流量从overlay设备以<code>隧道的形式</code>发送到对端）</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> a</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 宿主机A输出网卡信息</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enp1s0:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1500</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fq_codel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qlen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> d0:0d:f8:2a:2f:b2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.16.203.47/21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.16.207.255</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dynamic</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noprefixroute</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enp1s0</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">2:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flannel.1:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1450</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noqueue</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UNKNOWN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> d6:62:0a:2f:b4:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.0.0/32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flannel.1</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">3:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cni0:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1450</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noqueue</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qlen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ae:87:60:9d:63:ac</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.0.1/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.0.255</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cni0</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">4:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> veth6c306fc3@if3:</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">5:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vethda0af07c@if3:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 进入宿主机A上的容器</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loki-0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loki</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /bin/sh</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># loki的网络是 inet 10.244.0.12 属于宿主机A的网段 10.244.0.1/24</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 而宿主机B的网段是 10.244.1.1/24 很明显不是同一个网段</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> a</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">3:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0@if18:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_UP,M-DOW</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">N&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1450</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noqueue</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5e:54:5a:33:85:5d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.0.12/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.0.255</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 宿主机B网卡信息</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enp1s0:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1500</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fq_codel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qlen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> d0:0d:29:05:8f:ed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.16.203.55/21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.16.207.255</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dynamic</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noprefixroute</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enp1s0</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">2:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flannel.1:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1450</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noqueue</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UNKNOWN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0e:99:60:d8:96:e6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.1.0/32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.1.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flannel.1</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">3:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cni0:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">P&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">mtu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1450</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> noqueue</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qlen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1000</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    link/ether</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> e2:e2:ee:49:c5:c8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ff:ff:ff:ff:ff:ff</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.244.1.1/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.1.255</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> global</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cni0</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 很多pair对的对端插到网桥cni0上面 | 如果containerd runtime是docker那么这个是docker0</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 宿主机上的pod的ip都会属于网段 cni0 cidr 10.244.0.1/24</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> brctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> show</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">bridge</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     bridge</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> id</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">               STP</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enabled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     interfaces</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cni0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            8000.ae87609d63ac</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       no</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">              veth6c306fc3</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                                                        vethda0af07c</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_2-宿主机b访问宿主机a上面的pod数据流转" tabindex="-1"><a class="header-anchor" href="#_2-宿主机b访问宿主机a上面的pod数据流转"><span>2.宿主机B访问宿主机A上面的pod数据流转</span></a></h6><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 登陆宿主机B</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> route</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 默认路由，所有无法匹配其他路由表项的数据包将通过网卡enp1s0发送到IP地址10.16.207.254。</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.16.207.254</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enp1s0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dhcp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> metric</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 直连路由，表示该主机与子网10.16.200.0/21直接相连，本地IP地址为10.16.203.55。</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">10.16.200.0/21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enp1s0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.16.203.55</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> metric</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 静态路由，所有目标为10.244.0.0/24的数据包将通过接口flannel.1发送到目标地址10.244.0.0。</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">10.244.0.0/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flannel.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> onlink</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 直连路由，表示该主机与子网10.244.1.0/24直接相连，本地IP地址为10.244.1.1</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">10.244.1.0/24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cni0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.1.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 第一步数据会一句静态路由 10.244.0.0/24 流转到flannel.1</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.0.12</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-flannel网络通信原理实验" tabindex="-1"><a class="header-anchor" href="#_4-flannel网络通信原理实验"><span>4.flannel网络通信原理实验</span></a></h3><ol><li><p>同节点的pod之间通信</p><p>在容器启动前，会为容器创建一个虚拟Ethernet接口对，这个接口对类似于管道的两端，其中一端在主机命名空间中，另外一端在容器命名空间中，并命名为eth0。 在主机命名空间的接口会绑定到网桥。网桥的地址段会取IP赋值给容器的eth0接口。</p></li></ol><blockquote><p>利用nodeName特性将Pod调度到相同的node节点上（亲和性）</p></blockquote><div class="language-yml line-numbers-mode" data-highlighter="shiki" data-ext="yml" data-title="yml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># p1.yml</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Pod</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  labels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    run</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">nginx</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">p1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">default</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  nodeName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">k8s-node1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  containers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">busybox</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">c1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    command</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ping&quot;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;baidu.com&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yml line-numbers-mode" data-highlighter="shiki" data-ext="yml" data-title="yml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># p2.yaml</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Pod</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  labels</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    run</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">busybox</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">p2</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">default</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  nodeName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">k8s-node1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  containers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">busybox</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">c2</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    command</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ping&quot;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;baidu.com&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apply</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p1.yaml</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p2.yaml</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pod</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p{1,2}</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pod</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p{1,2}</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wide</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># p1 ping p2</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ping</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.244.1.230</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 源容器向目标容器发送数据，数据首先发送给 cni0 网桥</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> c1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> route</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> p2</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> c2</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> route</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># cni0 网桥接受到数据后，将其转交给 flannel.1 虚拟网卡处理</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># flannel.1 接受到数据后，对数据进行封装，并发给宿主机的 ens33，再通过ens33出外网，或者访问不同node节点上的pod</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/images/flannel-same-pod.png" alt="想同节点的不同pod之间的通信-基于flannel" tabindex="0" loading="lazy"><figcaption>想同节点的不同pod之间的通信-基于flannel</figcaption></figure><h3 id="_5-flannel网络之中service是如何转发数据的" tabindex="-1"><a class="header-anchor" href="#_5-flannel网络之中service是如何转发数据的"><span>5.flannel网络之中service是如何转发数据的</span></a></h3><figure><img src="/images/service-flannel.webp" alt="service-flannel" tabindex="0" loading="lazy"><figcaption>service-flannel</figcaption></figure><ol><li>service提供DNS解析、pod动态追踪更新转发表，域名规则为{服务名}.{namespace}.svc.{集群名称}，iptables维护和转发。</li><li>仅支持udp和tcp协议，所以ping的icmp协议是用不了的。</li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看DNS</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> endpoints</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> x</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/images/node-port-svc.png" alt="nodePort svc" tabindex="0" loading="lazy"><figcaption>nodePort svc</figcaption></figure><h3 id="q-a" tabindex="-1"><a class="header-anchor" href="#q-a"><span>Q&amp;A</span></a></h3><h5 id="_1-什么叫做直连路由" tabindex="-1"><a class="header-anchor" href="#_1-什么叫做直连路由"><span>1. 什么叫做直连路由</span></a></h5><ol><li>目的地与源地址直接相连的路由。</li><li>同一个子网中，可直发送到目的地，不需要任何中转设备或路由器。</li><li>在物理层或链路层上直接相连。</li><li>示例：<code>173.8.8.0/24 dev br2 proto kernel scope link src 173.8.8.1</code>因为本机网桥br2就是<code>inet 173.8.8.1</code>。</li></ol><h5 id="_2-ip-route和route-n区别是什么" tabindex="-1"><a class="header-anchor" href="#_2-ip-route和route-n区别是什么"><span>2. ip route和route -n区别是什么</span></a></h5><p><code>route -n</code>和<code>ip route</code>命令都是用于查看和管理系统的路由表，但有一些区别：</p><ol><li>语法：<code>route -n</code>是基于<code>net-tools</code>软件包的命令，而<code>ip route</code>是基于<code>iproute2</code>软件包的命令。<code>iproute2</code>是较新的工具集，可以提供更多的功能和选项。</li><li><code>ip route</code>命令的输出格式更为规范，以CIDR表示法显示网络和子网掩码，而不显示目标网络的广播地址。</li><li><code>ip route</code>命令更推荐使用。</li></ol><h5 id="_3-flannel-1网卡接收到的流量会发给谁" tabindex="-1"><a class="header-anchor" href="#_3-flannel-1网卡接收到的流量会发给谁"><span>3. flannel.1网卡接收到的流量会发给谁</span></a></h5><ol><li>在flannel中，flannel.1网卡是用于虚拟网络通信的网络接口。</li><li>当flannel.1网卡接收到流量时，它会将流量转发给flannel进程。</li><li>flannel进程负责将流量封装并发送到其他节点上的flannel进程，以便在不同节点之间建立覆盖网络。</li><li>流量会达到目标节点的flannel进程，并被解封装并交给目标节点上的网络接口进行处理</li></ol><h5 id="_4-flannel-1接收到的流量不会根据iptable或者其他的转发吗" tabindex="-1"><a class="header-anchor" href="#_4-flannel-1接收到的流量不会根据iptable或者其他的转发吗"><span>4. flannel.1接收到的流量不会根据iptable或者其他的转发吗</span></a></h5><ol><li>Flannel不会根据iptables或其他转发规则对流量进行处理;</li><li>Flannel通过隧道技术发送数据包;</li><li>容器发送网络请求时，数据包会经过容器的网卡（容器内部会根据iptable转发）然后数据包会到达宿主机的Flannel网卡(flannel.1)；</li><li>Flannel.1收到数据会到flanneld，根据自己路由表，将数据包封装成特定的协议（如VXLAN或UDP），并通过UDP或者其他方式将数据包发送到目标节点的Flannel网卡；</li></ol><h5 id="_5-kube-proxy在flannel网络之中有什么用" tabindex="-1"><a class="header-anchor" href="#_5-kube-proxy在flannel网络之中有什么用"><span>5. kube-proxy在flannel网络之中有什么用</span></a></h5><ol><li>提供服务的负载均衡和网络代理功能;</li><li>负载均衡：Service和其对应的多个Endpoint使用kube-proxy；</li><li>网络代理：将集群外部的请求转发到内部的服务（kube-proxy为Service创建虚拟IP并监听该IP）；</li><li>kube-proxy可以选择使用IPVS模式(比默认iptables性能更高)；</li></ol><h5 id="_6-kube-proxy-为每个service创建一个虚拟ip是什么意思" tabindex="-1"><a class="header-anchor" href="#_6-kube-proxy-为每个service创建一个虚拟ip是什么意思"><span>6. kube-proxy 为每个Service创建一个虚拟IP是什么意思</span></a></h5><ol><li>kube-proxy负责实现服务发现和负载均衡功能。</li><li>kube-proxy会为Service创建虚拟IP（Virtual IP），这个虚拟IP是由kube-proxy自动生成的，用于代表该Service在集群内的访问地址。</li><li>pod访问svc域名时候会转发到该虚拟IP上，kube-proxy监听该IP并转发数据到svc的Endpoint；</li><li>svc的虚拟IP可以实现后端Pod的变动与Service的访问地址解耦，Pod的变化不会影响到虚拟IP；</li></ol><h5 id="_7-ipvsadm-ln是什么意思-flannel和ipvs什么关系" tabindex="-1"><a class="header-anchor" href="#_7-ipvsadm-ln是什么意思-flannel和ipvs什么关系"><span>7. ipvsadm -Ln是什么意思，flannel和ipvs什么关系</span></a></h5><p>linux系统上IPVS（IP Virtual Server）的配置和状态信息; IPVS是Linux内核提供的一种高性能负载均衡技术，它可以在Linux系统上进行网络流量的分发和负载均衡。 IPVS可以作为kube-proxy的一种模式来实现负载均衡和代理转发功能。</p><h5 id="_8-flannel和kube-proxy是什么关系" tabindex="-1"><a class="header-anchor" href="#_8-flannel和kube-proxy是什么关系"><span>8. flannel和kube-proxy是什么关系</span></a></h5><ol><li>Flannel（容器间的网络通信）和kube-proxy（服务发现和负载均衡功能）</li><li>Pod的IP分配：Flannel为每个Pod分配一个唯一的虚拟IP地址，并使用网络隔离技术（如VXLAN、UDP封装等）实现容器之间的通信。</li><li>跨节点通信：Flannel还负责将节点的主机网络连接起来，以便跨节点的Pod可以相互通信。</li><li>kube-proxy在service上创建虚拟IP并监听，并负载均衡转发backend的Pod。</li></ol><h3 id="相关资料" tabindex="-1"><a class="header-anchor" href="#相关资料"><span>相关资料</span></a></h3><ul><li><a href="https://mp.weixin.qq.com/s/18bMpQjXFodfegWH3xNeKQ" target="_blank" rel="noopener noreferrer">Kubernetes（k8s）CNI（flannel）网络模型原理</a></li><li><a href="https://baijiahao.baidu.com/s?id=1677418078665703072" target="_blank" rel="noopener noreferrer">《蹲坑学K8S》之19-3：Flannel通信原理</a></li><li><a href="https://atbug.com/deep-dive-k8s-network-mode-and-communication/" target="_blank" rel="noopener noreferrer"> Kubernetes 网络模型和网络通信</a></li><li><a href="https://atbug.com/cross-node-traffic-on-flannel-vxlan-network/" target="_blank" rel="noopener noreferrer">从 Flannel 学习 Kubernetes overlay 网络 - 写的非常好</a></li></ul>',45)]))}]]),h=JSON.parse('{"path":"/posts/kubernetes/flanne%E6%8E%A5%E5%85%A5k8s.html","title":"flannel接入k8s","lang":"zh-CN","frontmatter":{"title":"flannel接入k8s","tags":["kubernetes"],"categories":["kubernetes"],"description":"kubernetes网络解决方案flannel如何使用，拓扑图理解 1.kubernetes如何接入flannale k8s/概念/扩展/网络插件 k8s/概念/扩展/网络插件/containerd安装网络插件 k8s/概念/扩展/网络插件/CRI-O安装网络插件 k8s/概念/集群管理/安装扩展 deploying-flannel-with-kube...","gitInclude":[],"head":[["meta",{"property":"og:url","content":"https://weiqiangxu.github.io/posts/kubernetes/flanne%E6%8E%A5%E5%85%A5k8s.html"}],["meta",{"property":"og:site_name","content":"笔记本"}],["meta",{"property":"og:title","content":"flannel接入k8s"}],["meta",{"property":"og:description","content":"kubernetes网络解决方案flannel如何使用，拓扑图理解 1.kubernetes如何接入flannale k8s/概念/扩展/网络插件 k8s/概念/扩展/网络插件/containerd安装网络插件 k8s/概念/扩展/网络插件/CRI-O安装网络插件 k8s/概念/集群管理/安装扩展 deploying-flannel-with-kube..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://weiqiangxu.github.io/images/flannel-docker.webp"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:tag","content":"kubernetes"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"flannel接入k8s\\",\\"image\\":[\\"https://weiqiangxu.github.io/images/flannel-docker.webp\\",\\"https://weiqiangxu.github.io/images/flannel-same-pod.png\\",\\"https://weiqiangxu.github.io/images/service-flannel.webp\\",\\"https://weiqiangxu.github.io/images/node-port-svc.png\\"],\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xuweiqiang\\",\\"url\\":\\"https://weiqiangxu.github.io\\"}]}"]]},"headers":[{"level":3,"title":"1.kubernetes如何接入flannale","slug":"_1-kubernetes如何接入flannale","link":"#_1-kubernetes如何接入flannale","children":[]},{"level":3,"title":"2.flannel通信原理简述","slug":"_2-flannel通信原理简述","link":"#_2-flannel通信原理简述","children":[]},{"level":3,"title":"3.flannel下网卡网桥查看","slug":"_3-flannel下网卡网桥查看","link":"#_3-flannel下网卡网桥查看","children":[]},{"level":3,"title":"4.flannel网络通信原理实验","slug":"_4-flannel网络通信原理实验","link":"#_4-flannel网络通信原理实验","children":[]},{"level":3,"title":"5.flannel网络之中service是如何转发数据的","slug":"_5-flannel网络之中service是如何转发数据的","link":"#_5-flannel网络之中service是如何转发数据的","children":[]},{"level":3,"title":"Q&A","slug":"q-a","link":"#q-a","children":[]},{"level":3,"title":"相关资料","slug":"相关资料","link":"#相关资料","children":[]}],"readingTime":{"minutes":8.84,"words":2651},"filePathRelative":"posts/kubernetes/flanne接入k8s.md","excerpt":"<blockquote>\\n<p>kubernetes网络解决方案flannel如何使用，拓扑图理解</p>\\n</blockquote>\\n<h3>1.kubernetes如何接入flannale</h3>\\n<p><a href=\\"https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">k8s/概念/扩展/网络插件</a>\\n<a href=\\"https://github.com/containerd/containerd/blob/main/script/setup/install-cni\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">k8s/概念/扩展/网络插件/containerd安装网络插件</a>\\n<a href=\\"https://github.com/cri-o/cri-o/blob/main/contrib/cni/README.md\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">k8s/概念/扩展/网络插件/CRI-O安装网络插件</a>\\n<a href=\\"https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/#networking-and-network-policy\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">k8s/概念/集群管理/安装扩展</a>\\n<a href=\\"https://github.com/flannel-io/flannel#deploying-flannel-with-kubectl\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">deploying-flannel-with-kubectl</a>\\n<a href=\\"https://github.com/flannel-io/flannel#deploying-flannel-with-helm\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">deploying-flannel-with-helm</a></p>","autoDesc":true}')}}]);